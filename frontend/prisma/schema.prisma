// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id          String   @id @default(cuid())
  clerkId     String   @unique
  walletAddress String? @unique
  githubUsername String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  organizations OrganizationMember[]
  contributions  Contribution[]
  rewards        Reward[]

  @@map("users")
}

model Organization {
  id          String   @id @default(cuid())
  name        String
  githubOrgId String?  @unique
  adminId     String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  members     OrganizationMember[]
  repos       Repo[]

  @@map("organizations")
}

model OrganizationMember {
  id             String   @id @default(cuid())
  userId         String
  organizationId String
  role           String   @default("member") // admin, member
  joinedAt       DateTime @default(now())

  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([userId, organizationId])
  @@map("organization_members")
}

model Repo {
  id             String   @id @default(cuid())
  organizationId String
  githubRepoId   String   @unique
  name           String
  fullName       String
  url            String
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())

  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  contributions  Contribution[]

  @@map("repos")
}

model Contribution {
  id             String   @id @default(cuid())
  userId         String
  repoId         String?
  contributionType String // "issue", "pr", "commit"
  externalId     String   // GitHub ID
  points         Int
  metadata       Json?    // Additional data
  onChainTxHash  String?
  createdAt      DateTime @default(now())

  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  repo           Repo?    @relation(fields: [repoId], references: [id])

  @@map("contributions")
}

model Reward {
  id             String   @id @default(cuid())
  userId         String
  amount         String   // CELO amount
  rewardType     String   // "weekly", "milestone"
  onChainTxHash  String?
  claimedAt      DateTime?
  createdAt      DateTime @default(now())

  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("rewards")
}

// Cached on-chain data for performance
model CachedLeaderboard {
  id        String   @id @default(cuid())
  period    String   // "weekly", "monthly"
  data      Json     // Cached leaderboard data
  cachedAt  DateTime @default(now())
  expiresAt DateTime

  @@unique([period])
  @@map("cached_leaderboards")
}

model CachedUserStats {
  id        String   @id @default(cuid())
  userId    String   @unique
  data      Json     // Cached user stats
  cachedAt  DateTime @default(now())
  expiresAt DateTime

  @@map("cached_user_stats")
}